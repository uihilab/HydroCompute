<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>wasm/modules/modules.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="engine.html">engine</a><ul class='methods'><li data-type='method'><a href="engine.html#.availableScripts">availableScripts</a></li><li data-type='method'><a href="engine.html#.concurrentRun">concurrentRun</a></li><li data-type='method'><a href="engine.html#.initialize">initialize</a></li><li data-type='method'><a href="engine.html#.parallelRun">parallelRun</a></li><li data-type='method'><a href="engine.html#.run">run</a></li><li data-type='method'><a href="engine.html#.setEngine">setEngine</a></li><li data-type='method'><a href="engine.html#.stepRun">stepRun</a></li><li data-type='method'><a href="engine.html#.taskRunner">taskRunner</a></li></ul></li><li><a href="hydroCompute.html">hydroCompute</a><ul class='methods'><li data-type='method'><a href="hydroCompute.html#availableEngines">availableEngines</a></li><li data-type='method'><a href="hydroCompute.html#availableResults">availableResults</a></li><li data-type='method'><a href="hydroCompute.html#availableSplits">availableSplits</a></li><li data-type='method'><a href="hydroCompute.html#currentEngine">currentEngine</a></li><li data-type='method'><a href="hydroCompute.html#data">data</a></li><li data-type='method'><a href="hydroCompute.html#engineScripts">engineScripts</a></li><li data-type='method'><a href="hydroCompute.html#getResTimes">getResTimes</a></li><li data-type='method'><a href="hydroCompute.html#getTotalTime">getTotalTime</a></li><li data-type='method'><a href="hydroCompute.html#isEngineSet">isEngineSet</a></li><li data-type='method'><a href="hydroCompute.html#makeId">makeId</a></li><li data-type='method'><a href="hydroCompute.html#results">results</a></li><li data-type='method'><a href="hydroCompute.html#run">run</a></li><li data-type='method'><a href="hydroCompute.html#setEngine">setEngine</a></li><li data-type='method'><a href="hydroCompute.html#setResults">setResults</a></li><li data-type='method'><a href="hydroCompute.html#setTotalTime">setTotalTime</a></li></ul></li><li><a href="threadManager.html">threadManager</a><ul class='methods'><li data-type='method'><a href="threadManager.html#.createWorkerThread">createWorkerThread</a></li><li data-type='method'><a href="threadManager.html#.initializeWorkerThread">initializeWorkerThread</a></li><li data-type='method'><a href="threadManager.html#.resetWorkers">resetWorkers</a></li></ul><ul class='members'><li data-type='method'><a href="threadManager.html#.execTimes">execTimes</a></li></ul></li><li><a href="WebRTC.html">WebRTC</a><ul class='methods'><li data-type='method'><a href="WebRTC.html#.createAnswer">createAnswer</a></li><li data-type='method'><a href="WebRTC.html#.createOfferDescription">createOfferDescription</a></li><li data-type='method'><a href="WebRTC.html#.initialize">initialize</a></li><li data-type='method'><a href="WebRTC.html#.onAvailableChannel">onAvailableChannel</a></li><li data-type='method'><a href="WebRTC.html#.oncloseHost">oncloseHost</a></li><li data-type='method'><a href="WebRTC.html#.oncloseReceiver">oncloseReceiver</a></li><li data-type='method'><a href="WebRTC.html#.openConnection">openConnection</a></li><li data-type='method'><a href="WebRTC.html#.restartDataChannel">restartDataChannel</a></li><li data-type='method'><a href="WebRTC.html#.run">run</a></li><li data-type='method'><a href="WebRTC.html#.sendData">sendData</a></li><li data-type='method'><a href="WebRTC.html#.setConnection">setConnection</a></li><li data-type='method'><a href="WebRTC.html#.setDataChannel">setDataChannel</a></li><li data-type='method'><a href="WebRTC.html#.setOfferDescription">setOfferDescription</a></li><li data-type='method'><a href="WebRTC.html#.submitArray">submitArray</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-kernels.html">kernels</a></li><li><a href="Worker.module_GPUWorker.html">GPUWorker</a></li><li><a href="Workers.module_JSWorker.html">JSWorker</a></li><li><a href="Workers.module_WASMWorker.html">WASMWorker</a><ul class='methods'><li data-type='method'><a href="Workers.module_WASMWorker.html#~handleAS">handleAS</a></li><li data-type='method'><a href="Workers.module_WASMWorker.html#~handleC">handleC</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="ErrorTypes.html">ErrorTypes</a><ul class='members'><li data-type='method'><a href="ErrorTypes.html#.NotFound">NotFound</a></li><li data-type='method'><a href="ErrorTypes.html#.NotImplemented">NotImplemented</a></li><li data-type='method'><a href="ErrorTypes.html#.ValueErr">ValueErr</a></li></ul></li><li><a href="globalUtils.html">globalUtils</a><ul class='methods'><li data-type='method'><a href="globalUtils.html#.arrayChanger">arrayChanger</a></li><li data-type='method'><a href="globalUtils.html#.concatArrays">concatArrays</a></li><li data-type='method'><a href="globalUtils.html#.DAG">DAG</a></li><li data-type='method'><a href="globalUtils.html#.dataCloner">dataCloner</a></li><li data-type='method'><a href="globalUtils.html#.flattenFloat32Array">flattenFloat32Array</a></li><li data-type='method'><a href="globalUtils.html#.getPerformanceMeasures">getPerformanceMeasures</a></li><li data-type='method'><a href="globalUtils.html#.importJSONdata">importJSONdata</a></li></ul></li><li><a href="gpuScripts.html">gpuScripts</a><ul class='members'><li data-type='method'><a href="gpuScripts.html#.gpuScripts">gpuScripts</a></li><li data-type='method'><a href="gpuScripts.html#.matrixUtils_gpu">matrixUtils_gpu</a></li></ul></li><li><a href="gpuUtils.html">gpuUtils</a><ul class='members'><li data-type='method'><a href="gpuUtils.html#.bindGroup">bindGroup</a></li><li data-type='method'><a href="gpuUtils.html#.bindLayout">bindLayout</a></li><li data-type='method'><a href="gpuUtils.html#.bufferCreator">bufferCreator</a></li><li data-type='method'><a href="gpuUtils.html#.bufferDestroyer">bufferDestroyer</a></li><li data-type='method'><a href="gpuUtils.html#.computingPipelines">computingPipelines</a></li><li data-type='method'><a href="gpuUtils.html#.deviceConnect">deviceConnect</a></li><li data-type='method'><a href="gpuUtils.html#.dispatchers">dispatchers</a></li><li data-type='method'><a href="gpuUtils.html#.exports.matrixChanger">exports.matrixChanger</a></li><li data-type='method'><a href="gpuUtils.html#.groupEntry">groupEntry</a></li><li data-type='method'><a href="gpuUtils.html#.layoutEntry">layoutEntry</a></li><li data-type='method'><a href="gpuUtils.html#.matrixSize">matrixSize</a></li><li data-type='method'><a href="gpuUtils.html#.resultHolder">resultHolder</a></li><li data-type='method'><a href="gpuUtils.html#.shaderModule">shaderModule</a></li></ul></li><li><a href="jsScripts.html">jsScripts</a><ul class='members'><li data-type='method'><a href="jsScripts.html#.jsScripts">jsScripts</a></li><li data-type='method'><a href="jsScripts.html#.matrixUtils_js">matrixUtils_js</a></li><li data-type='method'><a href="jsScripts.html#.timeSeries_js">timeSeries_js</a></li></ul></li><li><a href="splits.html">splits</a><ul class='methods'><li data-type='method'><a href="splits.html#.divideIntoSubmatrices">divideIntoSubmatrices</a></li><li data-type='method'><a href="splits.html#.join">join</a></li><li data-type='method'><a href="splits.html#.main">main</a></li><li data-type='method'><a href="splits.html#.split1DArray">split1DArray</a></li><li data-type='method'><a href="splits.html#.splitMatrix">splitMatrix</a></li><li data-type='method'><a href="splits.html#.splitmDArray">splitmDArray</a></li></ul></li><li><a href="WASMUtils.html">WASMUtils</a><ul class='methods'><li data-type='method'><a href="WASMUtils.html#._location">_location</a></li><li data-type='method'><a href="WASMUtils.html#.ASModule">ASModule</a></li><li data-type='method'><a href="WASMUtils.html#.avScripts">avScripts</a></li><li data-type='method'><a href="WASMUtils.html#.CModule">CModule</a></li><li data-type='method'><a href="WASMUtils.html#.filterFunctionKeys">filterFunctionKeys</a></li><li data-type='method'><a href="WASMUtils.html#.getAllModules">getAllModules</a></li><li data-type='method'><a href="WASMUtils.html#.loadModule">loadModule</a></li></ul><ul class='members'><li data-type='method'><a href="WASMUtils.html#.AScriptUtils">AScriptUtils</a></li><li data-type='method'><a href="WASMUtils.html#.ASUtils">ASUtils</a></li><li data-type='method'><a href="WASMUtils.html#.availableScripts">availableScripts</a></li><li data-type='method'><a href="WASMUtils.html#.CUtils">CUtils</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">wasm/modules/modules.js</h1>
    
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { CUtils } from "./C/mods.js";
import { ASUtils } from "./assemblyScript/mods.js";

/**
 * @namespace WASMUtils
 */


/**
 * @memberof WASMUtils
 * @description object container of relative paths for the Web Assembly modules
 */
const availableScripts = {
  C: "../../wasm/modules/C",
  //assemblyScrpt utils
  AS: "../../wasm/modules/assemblyScript",
};

/**
 * @description Returns the location of a specified utility in a given script or module.
 * @memberof WASMUtils
 * @param {string} scName - The name of the script or module.
 * @param {string} utilName - The name of the utility.
 * @returns {string} - The location of the specified utility in the given script or module.
 */
const _location = (scriptName, utilName) => {
  const getModule = (utils, name) => {
    if (utils.hasOwnProperty(name)) {
      return utils[name];
    }
    throw new Error(
      `No utils found with the name '${name}' in the given module`
    );
  };

  switch (scriptName) {
    case "C":
      const cUtils = getModule(CUtils, utilName);
      return new URL(
        `${availableScripts.C}/${utilName}/${cUtils}`,
        import.meta.url
      );
    case "AS":
      const asUtils = getModule(ASUtils, utilName);
      return new URL(
        `${availableScripts.AS}/${utilName}/${asUtils}`,
        import.meta.url
      );
    default:
      throw new Error(`No script or module with the name '${scriptName}'`);
  }
};

/**
 * @description Load and instantiate a WebAssembly module from the ASUtils script directory.
 * @memberof WASMUtils
 * @async
 * @param {string} name - The name of the module to load.
 * @returns {Promise} - An object representing the exports of the instantiated module.
 * @throws {Error} - If the module cannot be loaded or instantiated.
 */
const ASModule = async (name) => {
  const memory = new WebAssembly.Memory({
    initial: 1,
    //maximum: 100,
    //shared: true,
  });
  try {
    // const module = await WebAssembly.instantiateStreaming(
    //   fetch(_location("AS", name)),
    //   {
    //     js: { mem: memory },
    //     env: {
    //       abort: (_msg, _file, line, column) =>
    //         console.error(`Abort at ${line}: ${column}`),
    //       memory: memory,
    //     },
    //   }
    // );

    const response = await fetch(_location("AS", name));
    const buffer = await response.arrayBuffer();
    const module = await WebAssembly.instantiate(buffer,     
        {
          js: { mem: memory },
          env: {
            abort: (_msg, _file, line, column) =>
              console.error(`Abort at ${line}: ${column}`),
            memory: memory,
          },
        })

    return module.instance.exports;
  } catch (error) {
    throw new Error(`Failed to load AS module '${name}'.`, error);
  }
};

/**
 * @description Asynchronously loads and creates a module from a C script.
 * @memberof WASMUtils
 * @param {string} moduleName - The name of the module to load.
 * @returns {Promise} A promise that resolves to the module.
 * @throws Will throw an error if there was an error loading the module.
 */
const CModule = async (modName) => {
  try {
    let { default: Module } = await import(_location("C", modName));
    return Module();
  } catch (error) {
    console.error(
      `There was an error pulling the following module: ${modName}`,
      error
    );
  }
};

/**
 * @description Utility class for dealing with AS compiled WASM.
 * @member AScriptUtils
 * @memberof WASMUtils
 * @property lifTypedArray
 */
class AScriptUtils {
  constructor() {
    this.dataview = undefined;
    this.memory = undefined;
    this.refCounts = new Map();
  }

  /**
   * Lifts a TypedArray from the module's memory.
   * @param {TypedArrayConstructor} constructor - The constructor of the TypedArray.
   * @param {number} pointer - The memory pointer to the TypedArray.
   * @param {object} module - The AScript module.
   * @returns {TypedArray|null} - The lifted TypedArray.
   */
  liftTypedArray(constructor, pointer, module) {
    if (!pointer) return null;
    return new constructor(
      module.memory.buffer,
      this.getU32(pointer + 4, module),
      this.dataview.getUint32(pointer + 8, true) / constructor.BYTES_PER_ELEMENT
    ).slice();
  }

  /**
   * Lowers a TypedArray to the module's memory.
   * @param {TypedArrayConstructor} constructor - The constructor of the TypedArray.
   * @param {number} id - The identifier of the TypedArray.
   * @param {number} align - The alignment of the TypedArray.
   * @param {TypedArray} values - The TypedArray to lower.
   * @param {object} module - The AScript module.
   * @returns {number} - The memory pointer to the lowered TypedArray.
   */
  lowerTypedArray(constructor, id, align, values, module) {
    if (values == null) return 0;

    const length = values.length,
      buffer = module.__pin(module.__new(length &lt;&lt; align, 1)) >>> 0,
      header = module.__new(12, id) >>> 0;

    this.setU32(header + 0, buffer, module);
    this.dataview.setUint32(header + 4, buffer, true);
    this.dataview.setUint32(header + 8, length &lt;&lt; align, true);
    new constructor(module.memory.buffer, buffer, length).set(values);
    module.__unpin(buffer);
    return header;
  }

  /**
   * Retains a memory pointer and increments its reference count.
   * @param {number} pointer - The memory pointer to retain.
   * @param {object} module - The AScript module.
   * @returns {number} - The retained memory pointer.
   */
  retainP(pointer, module) {
    if (pointer) {
      const refcount = this.refCounts.get(pointer);
      if (refcount) this.refCounts.set(pointer, refcount + 1);
      else this.refCounts.set(module.__pin(pointer), 1);
    }
    return pointer;
  }

  /**
   * Releases a memory pointer and decrements its reference count.
   * @param {number} pointer - The memory pointer to release.
   * @param {object} module - The AScript module.
   */
  releaseP(pointer, module) {
    if (pointer) {
      const refcount = this.refCounts.get(pointer);
      if (refcount === 1)
        module.__unpin(pointer), this.refCounts.delete(pointer);
      else if (refcount) this.refCounts.set(pointer, refcount - 1);
      else
        throw Error(
          `No refcounter "${refcount}" for the reference "${pointer}".`
        );
    }
  }

/**
 * Sets a 32-bit unsigned integer value at the specified memory pointer.
 * @param {number} pointer - The memory pointer.
 * @param {number} value - The value to set.
 * @param {object} module - The AScript module.
 */
  setU32(pointer, value, module) {
    try {
      this.dataview.setUint32(pointer, value, true);
    } catch {
      this.dataview = new DataView(module.memory.buffer);
      this.dataview.setInt32(pointer, value, true);
    }
  }

/**
 * Gets a 32-bit unsigned integer value from the specified memory pointer.
 * @param {number} pointer - The memory pointer.
 * @param {object} module - The AScript module.
 * @returns {number} - The 32-bit unsigned integer value.
 */
  getU32(pointer, module) {
    try {
      return this.dataview.getUint32(pointer, true);
    } catch {
      this.dataview = new DataView(module.memory.buffer);
      return this.dataview.getUint32(pointer, true);
    }
  }
}

/**
 * @description Loads a module based on the script name and module name.
 * @memberof WASMUtils
 * @param {string} scriptName - The script name.
 * @param {string} moduleName - The module name.
 * @returns {Promise&lt;object>} - A promise that resolves to the loaded module.
 * @throws {NotFound} - If the module is not found in the available scripts.
 */
const loadModule = async (scriptName, moduleName) => {
  try {
    const myCurrentModule = await new Promise((resolve, reject) => {
      //Removes extension for each module
      resolve(
        scriptName === "AS"
          ? ASModule(moduleName.substring(0, moduleName.length - 5))
          : CModule(moduleName.substring(0, moduleName.length - 3))
      );
    });
    return myCurrentModule;
  } catch (e) {
    console.error(e);
    throw new NotFound(`Module not found in available scripts.`);
  }
};

/**
 * @description Retrieves all available modules.
 * @memberof WASMUtils
 * @returns {Promise&lt;object>} - A promise that resolves to an object containing all the available modules.
 */
const getAllModules = async () => {
  let wasmMods = {};
  let availableMods;
  for (var sc of Object.keys(availableScripts)) {
    if (sc === "C") {
      availableMods = Object.values(CUtils).map((val) => val);
    } else if (sc === "AS") {
      availableMods = Object.values(ASUtils).map((val) => val);
    }
    wasmMods[sc] = {};
    for (var mod of availableMods) {
      let stgMod = await loadModule(sc, mod);
      wasmMods[sc][
        sc === "AS"
          ? mod.substring(0, mod.length - 5)
          : mod.substring(0, mod.length - 3)
      ] = stgMod;
    }
  }
  return wasmMods;
};

/**
 * @description Retrieves all available scripts and their modules.
 * @memberof WASMUtils
 * @returns {Promise&lt;object>} - A promise that resolves to an object containing all the available scripts and their modules.
 */
const avScripts = async () => {
  const wasmMods = await getAllModules();
  const main = {};

  for (const scr of Object.keys(wasmMods)) {
    const modules = new Map();
    main[scr] = modules;
    for (const fn of Object.keys(wasmMods[scr])) {
      const fun = Array.from(filterFunctionKeys(wasmMods[scr][fn]));
      modules.set(fn, fun);
    }
  }

  return main;
};

/**
 * @description Filters the function keys of an object, excluding specific keys.
 * @memberof WASMUtils
 * @param {object} obj - The object to filter.
 * @returns {string[]} - An array of filtered function keys.
 */
function filterFunctionKeys(obj) {
  const excludeKeys = new Set([
    undefined,
    "memory",
    "__collect",
    "__new",
    "__pin",
    "__rtti_base",
    "__unpin",
    "__setArgumentsLength",
    "ready",
    "calledRun",
    "asm",
    "_createMem",
    "_destroy",
    "HEAP8",
    "HEAP16",
    "HEAP32",
    "HEAPU8",
    "HEAPU16",
    "HEAPU32",
    "HEAPF32",
    "HEAPF64",
  ]);
  return Object.keys(obj).filter((key) => !excludeKeys.has(key));
}

export {
  getAllModules,
  loadModule,
  AScriptUtils,
  ASModule,
  availableScripts,
  avScripts,
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Tue Jan 30 2024 21:44:03 GMT+0000 (Coordinated Universal Time) using the Toast theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
